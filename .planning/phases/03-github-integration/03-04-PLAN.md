---
phase: 03-github-integration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/github_service.py
  - src/views/bug_buttons.py
  - src/utils/github_templates.py
autonomous: true
gap_closure: true
requirements: [GH-04, GH-05, GH-06]

must_haves:
  truths:
    - "Draft Fix reads relevant source files from the GitHub repo using AI analysis context (ai_affected_area)"
    - "Draft Fix commits a context file to the feature branch before opening the PR (branch is not empty)"
    - "PR body includes relevant source file snippets so external tools and reviewers have full context"
  artifacts:
    - path: "src/services/github_service.py"
      provides: "read_repo_files and commit_context_file methods"
      contains: "async def read_repo_files"
    - path: "src/views/bug_buttons.py"
      provides: "Integration of file reading and context commit into _handle_draft_fix flow"
      contains: "read_repo_files"
    - path: "src/utils/github_templates.py"
      provides: "build_context_commit_content and enhanced build_pr_body with source file snippets"
      contains: "build_context_commit_content"
  key_links:
    - from: "src/views/bug_buttons.py"
      to: "src/services/github_service.py"
      via: "read_repo_files and commit_context_file calls in _handle_draft_fix"
      pattern: "github_service\\.read_repo_files|github_service\\.commit_context_file"
    - from: "src/views/bug_buttons.py"
      to: "src/utils/github_templates.py"
      via: "build_context_commit_content call for branch commit"
      pattern: "build_context_commit_content"
    - from: "src/services/github_service.py"
      to: "githubkit.rest.repos"
      via: "async_get_content for reading files and async_create_or_update_file_contents for commits"
      pattern: "async_get_content|async_create_or_update_file_contents"
---

<objective>
Close the GH-05 gap identified in VERIFICATION.md: Draft Fix currently creates an empty feature branch and PR scaffold with no source file reading and no commits.

After this plan, Draft Fix will:
1. Read relevant source files from the repo based on AI analysis (ai_affected_area, ai_root_cause)
2. Commit a structured context file to the feature branch (branch is no longer empty)
3. Include source file snippets in the PR body so external tools (Copilot/BugBot) and reviewers have full context

This satisfies the hybrid approach from CONTEXT.md: the bot provides rich context (source files, analysis, suggested fix), and external tools handle actual code generation. Per the user's locked decision, there is no Claude fallback for code generation -- the bot's job is to scaffold with maximum context.

Purpose: Close GH-04/GH-05/GH-06 verification gaps so Phase 3 fully satisfies ROADMAP Success Criterion #2
Output: Enhanced Draft Fix flow with source file reading, context commits, and enriched PR body
</objective>

<execution_context>
@C:/Users/silas/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/silas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-github-integration/03-03-SUMMARY.md
@.planning/phases/03-github-integration/03-CONTEXT.md
@.planning/phases/03-github-integration/03-RESEARCH.md
@.planning/phases/03-github-integration/03-VERIFICATION.md

@src/services/github_service.py
@src/views/bug_buttons.py
@src/utils/github_templates.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add repo file reading and context commit methods to GitHubService</name>
  <files>src/services/github_service.py, src/utils/github_templates.py</files>
  <action>
Add two new methods to `GitHubService` in `src/services/github_service.py`:

**1. `read_repo_files(owner, repo, file_paths, ref=None) -> list[dict]`**
- Takes a list of file paths to read from the repo
- For each path, calls `gh.rest.repos.async_get_content(owner, repo, path, ref=ref)`
- Returns a list of dicts: `{"path": str, "content": str, "size": int, "truncated": bool}`
- Content comes base64-encoded from the API -- decode it with `base64.b64decode(data.content).decode("utf-8")`
- If a file is larger than 50KB, truncate the content to the first 50KB and set `truncated=True`
- If a file path returns 404 or any error, skip it (log warning, continue to next file) -- do NOT fail the whole operation
- If `file_paths` is empty, return empty list immediately
- Add `import base64` at the top of the file (alongside existing imports)

**2. `commit_context_file(owner, repo, branch_name, file_path, content, message) -> None`**
- Commits a single file to an existing branch
- Uses `gh.rest.repos.async_create_or_update_file_contents(owner, repo, file_path, message=message, content=base64_content, branch=branch_name)`
- The `content` parameter to the API must be base64-encoded: `base64.b64encode(content.encode("utf-8")).decode("ascii")`
- This is how the bot commits to the feature branch without touching the default branch (GH-08 preserved)
- Log success at info level

**3. `identify_relevant_files(owner, repo, ai_affected_area, ref=None) -> list[str]`**
- Takes the `ai_affected_area` string from bug analysis (e.g., "Authentication module", "Camera capture flow")
- Gets the repo's file tree using `gh.rest.git.async_get_tree(owner, repo, ref or "HEAD", recursive="true")`
- From the tree, filter to files (not directories) that are source code files (extensions: .py, .js, .ts, .tsx, .jsx, .java, .kt, .swift, .dart, .go, .rs, .c, .cpp, .h, .rb, .php, .cs, .vue, .svelte)
- Score each file path by keyword overlap with `ai_affected_area` -- split the area into lowercase words, check how many appear in the lowercase file path (directory names count)
- Return the top 5 files with the highest score (score > 0 only), sorted by score descending
- If no files match, return an empty list
- This is a simple heuristic -- not full RAG indexing (per Out of Scope in REQUIREMENTS.md)

Also in `src/utils/github_templates.py`, add:

**4. `build_context_commit_content(bug, source_files) -> str`**
- Builds a markdown file to be committed to the branch as `.bugbot/context.md`
- Content structure:
  ```
  # Bug Context: #{hash_id}

  ## Bug Report
  **Title:** {title}
  **Description:** {description}
  **Severity:** {severity}

  ## AI Analysis
  - **Root Cause:** {ai_root_cause}
  - **Affected Area:** {ai_affected_area}
  - **Suggested Fix:** {ai_suggested_fix}

  ## Relevant Source Files

  ### {file_path}
  ```{ext}
  {content (first 200 lines max)}
  ```

  (repeat for each source file)
  ```
- If `source_files` is empty, include a note: "No relevant source files identified from repository."
- Each source file snippet is limited to the first 200 lines to keep the commit manageable

**5. Enhance `build_pr_body` to accept optional `source_files` parameter**
- Add `source_files: list[dict] | None = None` parameter to `build_pr_body`
- If source_files are provided, add a "### Relevant Source Files" section after the AI Analysis section
- For each file, show the path as a code reference (but NOT the full content -- that's in the committed context file)
- Format: bullet list of file paths, e.g., `- \`src/auth/login.py\` (245 lines)`
- Update the existing PR scaffold note to mention that a `.bugbot/context.md` file has been committed with full source context
  </action>
  <verify>
Verify by reading `src/services/github_service.py` and confirming:
- `read_repo_files` method exists with base64 decoding, error handling per file, and 50KB truncation
- `commit_context_file` method exists with base64 encoding and branch parameter
- `identify_relevant_files` method exists with tree walking and keyword scoring
- `import base64` is present

Verify by reading `src/utils/github_templates.py` and confirming:
- `build_context_commit_content` function exists and produces markdown with bug context and source snippets
- `build_pr_body` has `source_files` parameter and conditionally renders the "Relevant Source Files" section
  </verify>
  <done>
GitHubService has three new methods (read_repo_files, commit_context_file, identify_relevant_files) that can read source files from a repo, identify relevant files based on AI analysis, and commit files to a branch. github_templates has build_context_commit_content and enhanced build_pr_body.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate file reading and context commit into Draft Fix flow</name>
  <files>src/views/bug_buttons.py</files>
  <action>
Modify `_handle_draft_fix` in `src/views/bug_buttons.py` to add three steps between branch creation (step 7) and PR body building (step 8):

**After step 7 (create branch) and before step 8 (build PR body), insert:**

**Step 7a: Identify relevant source files**
- Call `bot.github_service.identify_relevant_files(owner, repo, bug.get("ai_affected_area", ""), ref=default_branch)`
- Store the result as `relevant_paths` (list of file path strings)
- Wrap in try/except -- if it fails, log warning and set `relevant_paths = []` (non-fatal)

**Step 7b: Read source files**
- If `relevant_paths` is non-empty, call `bot.github_service.read_repo_files(owner, repo, relevant_paths, ref=default_branch)`
- Store the result as `source_files` (list of dicts with path, content, size, truncated)
- If `relevant_paths` is empty, set `source_files = []`
- Wrap in try/except -- if it fails, log warning and set `source_files = []` (non-fatal)

**Step 7c: Commit context file to the branch**
- Import `build_context_commit_content` from `src.utils.github_templates`
- Build the context content: `context_content = build_context_commit_content(bug, source_files)`
- Call `bot.github_service.commit_context_file(owner, repo, branch_name, ".bugbot/context.md", context_content, f"Add bug context for #{bug['hash_id']}")`
- Wrap in try/except -- if it fails, log warning but continue (the PR can still be created without the commit; it just reverts to the old "empty branch" behavior)

**Modify step 8 (build PR body):**
- Pass `source_files=source_files` to the `build_pr_body` call so the PR body includes file references

Add `build_context_commit_content` to the import block at the top of the file (alongside existing imports from `src.utils.github_templates`).

IMPORTANT: All three new steps (7a, 7b, 7c) are wrapped in individual try/except blocks with logging. If ANY of them fail, the Draft Fix flow continues with the PR scaffold (graceful degradation). The existing error handling that deletes the branch on total failure remains unchanged.

The flow becomes:
1-6: (unchanged) Guards, branch name, default branch SHA
7: Create branch
7a: Identify relevant files (non-fatal)
7b: Read source files (non-fatal)
7c: Commit context file (non-fatal)
8-14: (modified step 8 passes source_files; rest unchanged) Build PR body, create PR, store in DB, update embed, notify thread
  </action>
  <verify>
Verify by reading `src/views/bug_buttons.py` and confirming:
- `build_context_commit_content` is imported from `src.utils.github_templates`
- `_handle_draft_fix` has steps 7a (identify_relevant_files), 7b (read_repo_files), and 7c (commit_context_file) between branch creation and PR body building
- Each new step is wrapped in its own try/except with a logger.warning call
- `build_pr_body` call includes `source_files=source_files` parameter
- The existing branch cleanup error handler is unchanged
  </verify>
  <done>
Draft Fix flow reads relevant source files from the repo based on AI analysis, commits a context file to the branch (branch is no longer empty), and includes file references in the PR body. All new steps degrade gracefully on failure. GH-04, GH-05, and GH-06 gaps are closed.
  </done>
</task>

</tasks>

<verification>
After both tasks are complete, verify:

1. **GH-05 (source file reading):** `_handle_draft_fix` calls `identify_relevant_files` then `read_repo_files` -- the bot actively reads source files from the repo using AI analysis context
2. **GH-06 (commits the fix):** `_handle_draft_fix` calls `commit_context_file` to commit `.bugbot/context.md` to the feature branch before opening the PR -- the branch has at least one commit
3. **GH-04 (AI-drafted):** The Draft Fix produces a PR with AI-identified source files, structured bug context committed to the branch, and enriched PR body -- this is the "AI-drafted scaffold" that external tools refine
4. **GH-08 preserved:** `commit_context_file` writes to the feature branch (branch parameter), never to the default branch
5. **Graceful degradation:** If file reading or commit fails, the Draft Fix still creates the PR scaffold (reverts to existing behavior)
6. **No Claude code generation fallback:** Per user decision, the bot reads and provides context but does NOT use Claude to generate code changes. The committed context file is informational, not executable code.
</verification>

<success_criteria>
- `GitHubService` has `read_repo_files`, `commit_context_file`, and `identify_relevant_files` methods
- `_handle_draft_fix` calls all three methods between branch creation and PR opening
- `.bugbot/context.md` is committed to the feature branch with bug analysis and relevant source file snippets
- PR body includes a "Relevant Source Files" section listing identified files
- All new steps handle errors gracefully (try/except with logging, non-fatal)
- No Claude API call for code generation (hybrid approach respected)
</success_criteria>

<output>
After completion, create `.planning/phases/03-github-integration/03-04-SUMMARY.md`
</output>
