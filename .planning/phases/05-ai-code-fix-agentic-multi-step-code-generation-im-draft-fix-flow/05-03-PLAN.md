---
phase: 05-ai-code-fix-agentic-multi-step-code-generation-im-draft-fix-flow
plan: 03
type: execute
wave: 3
depends_on:
  - 05-01
  - 05-02
files_modified:
  - src/views/bug_buttons.py
  - src/utils/github_templates.py
  - src/bot.py
autonomous: true
requirements:
  - GH-04
  - GH-05
  - GH-06

must_haves:
  truths:
    - "Clicking Draft Fix triggers the agentic code fix loop instead of scaffolding an empty PR"
    - "Live progress messages appear in the Discord thread during code generation"
    - "A completion embed shows files changed, rounds taken, validation results, PR link, and diff summary"
    - "The PR body includes a collapsible process log section"
    - "Token usage is displayed in progress messages (per-round and running total)"
    - "If validation did not fully pass, the PR body notes this clearly"
  artifacts:
    - path: "src/views/bug_buttons.py"
      provides: "Rewritten _handle_draft_fix that calls CodeFixService"
      contains: "code_fix_service"
    - path: "src/utils/github_templates.py"
      provides: "Process log builder and updated PR body template"
      exports: ["build_process_log_section", "build_code_fix_pr_body"]
    - path: "src/bot.py"
      provides: "CodeFixService initialization in setup_hook"
      contains: "code_fix_service"
  key_links:
    - from: "src/views/bug_buttons.py"
      to: "src/services/code_fix_service.py"
      via: "bot.code_fix_service.generate_fix"
      pattern: "code_fix_service\\.generate_fix"
    - from: "src/bot.py"
      to: "src/services/code_fix_service.py"
      via: "CodeFixService initialization"
      pattern: "CodeFixService\\("
    - from: "src/views/bug_buttons.py"
      to: "src/utils/github_templates.py"
      via: "build_code_fix_pr_body, build_process_log_section"
      pattern: "build_code_fix_pr_body|build_process_log_section"
---

<objective>
Integrate CodeFixService into the bot: rewrite the Draft Fix button handler to call the agentic code fix, add live Discord progress messages and completion embed, update PR body templates with process logs, and initialize the service in bot.py.

Purpose: This connects the Phase 5 backend (CodeFixService) to the Phase 3 frontend (Discord buttons and GitHub PRs). Users clicking Draft Fix now get real AI-generated code fixes with live progress feedback, rich completion notifications, and detailed PR descriptions.

Output: Rewritten `_handle_draft_fix` in bug_buttons.py, new template functions in github_templates.py, CodeFixService initialization in bot.py.
</objective>

<execution_context>
@C:/Users/silas/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/silas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-code-fix-agentic-multi-step-code-generation-im-draft-fix-flow/05-RESEARCH.md
@.planning/phases/05-ai-code-fix-agentic-multi-step-code-generation-im-draft-fix-flow/05-01-SUMMARY.md
@.planning/phases/05-ai-code-fix-agentic-multi-step-code-generation-im-draft-fix-flow/05-02-SUMMARY.md

@src/views/bug_buttons.py
@src/utils/github_templates.py
@src/bot.py
@src/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add process log builder and code fix PR body template to github_templates.py</name>
  <files>src/utils/github_templates.py</files>
  <action>
Add two new functions to github_templates.py:

**1. `build_process_log_section(process_log: dict) -> str`:**
Builds a collapsible HTML details block for the PR body showing the agentic process log.

Structure:
```markdown
<details>
<summary>ü§ñ AI Code Fix Process Log</summary>

**Rounds:** {rounds_taken}
**Files explored:** {count}
**Total tokens:** {input} input + {output} output = {total} total

### Round 1
- **Files changed:** `path1.py`, `path2.py`
- **Lint:** ‚úÖ Passed / ‚ùå Failed (ruff)
- **Self-review:** ‚úÖ Passed / ‚ùå Issues found
- **CI:** ‚úÖ Passed / ‚ùå Failed / ‚è≠Ô∏è Skipped (no CI) / ‚è±Ô∏è Timeout

### Round 2
...

</details>
```

- Input `process_log` dict has keys: `files_explored` (list of paths), `rounds` (list of round dicts), `total_tokens` (dict with `input` and `output`).
- Each round dict has: `round` (int), `files_changed` (list of paths), `tokens` (dict), and optionally `lint` (dict), `self_review` (dict), `ci` (dict).
- Format lint results: show linter name and pass/fail. If skipped (linter not installed or not found), note it.
- Format self-review: show pass/fail and issues list if any.
- Format CI: show status (passed/failed/no_ci/timeout) with details on failure.

**2. `build_code_fix_pr_body(bug, issue_number, discord_thread_url, process_log, changed_files, validation_passed) -> str`:**
Builds the full PR body for an AI-generated code fix PR. This REPLACES the old scaffold PR body format.

Structure:
```markdown
## Bug Fix: #{hash_id}

**Title:** {title}
**Description:** {desc_excerpt}

### AI Analysis
- **Root Cause:** {ai_root_cause}
- **Affected Area:** {ai_area}
- **Severity:** {ai_severity}
- **Suggested Fix:** {ai_fix}

### Changes Made
{for each file in changed_files:}
- `{path}` ({line_count} lines)

{if not validation_passed:}
> ‚ö†Ô∏è **Note:** AI validation did not fully pass after {rounds} rounds. Please review carefully.

{process_log_section from build_process_log_section}

üîó [Discord Thread]({discord_thread_url})

Closes #{issue_number}

---
> ü§ñ This fix was generated by PreserveFood BugBot's AI Code Fix engine.
```

- Use the same bug context extraction pattern as the existing `build_pr_body`.
- The `changed_files` param is a `dict[str, str]` of path -> content (to calculate line counts).
- Call `build_process_log_section` internally for the process log section.
- Keep the `Closes #N` only when issue_number is provided (same as existing behavior).
- If `validation_passed` is False, add a prominent warning note.

**Do NOT modify or remove the existing `build_pr_body` function** -- it's still used by other callers. The new function is a separate, enhanced version for code fix PRs.
  </action>
  <verify>
Run `python -c "from src.utils.github_templates import build_process_log_section, build_code_fix_pr_body; print('Import OK')"` to confirm no import errors. Verify that `build_pr_body` still exists unchanged.
  </verify>
  <done>github_templates.py has two new functions: build_process_log_section (collapsible HTML details with per-round lint/review/CI results and token counts) and build_code_fix_pr_body (full PR body with changes summary, validation warning, and process log). The existing build_pr_body is preserved for backward compatibility.</done>
</task>

<task type="auto">
  <name>Task 2: Initialize CodeFixService in bot.py and rewrite _handle_draft_fix</name>
  <files>src/bot.py, src/views/bug_buttons.py</files>
  <action>
**Part A: Initialize CodeFixService in bot.py**

1. Add import: `from src.services.code_fix_service import CodeFixService`
2. Add `self.code_fix_service: CodeFixService | None = None` in `__init__`.
3. In `setup_hook`, after the GitHub service initialization block, add:
```python
# Initialize Code Fix service (optional -- requires both AI and GitHub)
if self.config.ANTHROPIC_API_KEY and self.config.github_configured:
    self.code_fix_service = CodeFixService(
        api_key=self.config.ANTHROPIC_API_KEY,
        model=self.config.ANTHROPIC_CODE_FIX_MODEL,
        max_tokens=self.config.CODE_FIX_MAX_TOKENS,
        max_rounds=self.config.CODE_FIX_MAX_ROUNDS,
        max_files=self.config.CODE_FIX_MAX_FILES,
        ci_timeout=self.config.CODE_FIX_CI_TIMEOUT,
    )
    logger.info(
        "Code fix service initialized (model: %s, max_rounds: %d)",
        self.config.ANTHROPIC_CODE_FIX_MODEL,
        self.config.CODE_FIX_MAX_ROUNDS,
    )
else:
    logger.info("Code fix service not initialized (requires AI + GitHub)")
```

**Part B: Rewrite _handle_draft_fix in bug_buttons.py**

Replace the existing `_handle_draft_fix` method with a new implementation that uses CodeFixService. The new flow:

1. **Same guard checks** as before (steps 1-4): defer, fetch bug, status guards, re-trigger block, github_service check, guild config check. Keep these EXACTLY as-is.

2. **Add code_fix_service availability check** after the github_service check:
```python
if bot.code_fix_service is None:
    await interaction.followup.send(
        "AI code fix is not configured. Both ANTHROPIC_API_KEY and GitHub must be set.",
        ephemeral=True,
    )
    return
```

3. **Get the thread early** (needed for progress messages):
```python
thread = interaction.message.thread
if thread is None and bug.get("thread_id"):
    try:
        thread = bot.get_channel(bug["thread_id"])
        if thread is None:
            thread = await bot.fetch_channel(bug["thread_id"])
    except discord.HTTPException:
        thread = None
```

4. **Define progress callback:**
```python
async def post_progress(message: str):
    if thread is not None:
        try:
            await thread.send(f"üîß {message}")
        except discord.HTTPException:
            pass
    logger.info("Code fix progress [%s]: %s", self.bug_id, message)
```

5. **Branch creation** -- same as before (steps 5-7 from old handler: build branch name, get default branch SHA, create branch). Keep the 422 handling for existing branches.

6. **Identify relevant files** -- same as before (step 7a). Keep the try/except non-fatal pattern.

7. **Run code fix service** (REPLACES old steps 7b, 7c, 8, 9):
```python
await post_progress("Starting AI code fix generation...")
fix_result = await bot.code_fix_service.generate_fix(
    github_service=bot.github_service,
    owner=owner,
    repo=repo,
    branch=branch_name,
    bug=bug,
    relevant_paths=relevant_paths,
    progress_callback=post_progress,
)
```

8. **Handle result:**
   - If `fix_result["success"]` is False:
     - Log the error. Post in thread: "Code fix generation failed: {error}".
     - Still create the PR (with whatever was committed, if anything), or skip PR if nothing was committed.

9. **Build PR body using new template:**
```python
from src.utils.github_templates import build_code_fix_pr_body
pr_body = build_code_fix_pr_body(
    bug,
    issue_number=bug.get("github_issue_number"),
    discord_thread_url=discord_thread_url,
    process_log=fix_result.get("process_log", {}),
    changed_files=fix_result.get("changed_files", {}),
    validation_passed=fix_result.get("validation_passed", False),
)
```

10. **Update the existing PR** (if it was already created by the branch/commit flow) or **create a new PR**:
    - Since the code fix service commits to the branch, the PR creation (step 10 from old handler) stays the same.
    - Keep `create_pull_request` call as before.

11. **Store in DB, update embed, post in thread** -- same as old steps 11-13.

12. **Post completion embed** in thread (NEW):
    Create a rich Discord embed with:
    - Title: "AI Code Fix Complete" (green color if validation passed, yellow if not)
    - Fields: Files Changed (list of paths), Rounds Taken, Validation (Passed/Partial), PR link
    - Footer: Token usage summary (total input + output tokens)
    - If validation didn't pass: add a field noting which gates failed.

13. **Ephemeral confirmation** -- same as old step 14 but with richer message.

14. **Error handling** -- keep the same try/except pattern with branch cleanup on failure.

**Import additions for bug_buttons.py:**
- Add `build_code_fix_pr_body` to the existing import from `github_templates`.
- No need to import CodeFixService -- it's accessed via `bot.code_fix_service`.
  </action>
  <verify>
Run `python -c "from src.views.bug_buttons import BugActionButton, build_bug_view; print('Import OK')"` to confirm no import errors. Run `python -c "from src.bot import BugBot; print('Import OK')"` to confirm no import errors (will fail if env vars missing, but import should work). Visually inspect that _handle_draft_fix calls `bot.code_fix_service.generate_fix` and uses `build_code_fix_pr_body`.
  </verify>
  <done>bot.py initializes CodeFixService when both AI and GitHub are configured. bug_buttons.py's _handle_draft_fix calls CodeFixService.generate_fix with live progress callbacks, posts a completion embed with files changed / rounds / validation / tokens, and uses the new build_code_fix_pr_body template for the PR. All existing guard checks and error handling patterns are preserved.</done>
</task>

</tasks>

<verification>
1. `python -c "from src.bot import BugBot"` succeeds (import-level check)
2. `python -c "from src.views.bug_buttons import BugActionButton"` succeeds
3. `python -c "from src.utils.github_templates import build_code_fix_pr_body, build_process_log_section"` succeeds
4. bot.py creates CodeFixService when ANTHROPIC_API_KEY and github_configured are both set
5. _handle_draft_fix calls code_fix_service.generate_fix with progress_callback
6. Completion embed is posted in the thread after code fix generation
7. PR body uses build_code_fix_pr_body with process log section
8. Existing build_pr_body function is unchanged (backward compatible)
9. All guard checks (status, re-trigger, service availability) are preserved
</verification>

<success_criteria>
The Draft Fix button triggers the full agentic code fix pipeline: clone -> explore -> generate -> lint -> self-review -> CI -> iterate -> commit -> PR. Live progress messages appear in the Discord thread. A completion embed shows the result. The PR body includes a detailed process log. Token usage is tracked and displayed. The old scaffold-only behavior is fully replaced.
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-code-fix-agentic-multi-step-code-generation-im-draft-fix-flow/05-03-SUMMARY.md`
</output>
