---
phase: 06-developer-context-via-bot-mentions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/database.py
  - src/models/developer_notes.py
  - src/models/bug.py
  - src/cogs/developer_notes.py
  - src/bot.py
autonomous: true
requirements: [DEV-01, DEV-02, DEV-03, DEV-04, DEV-05]

must_haves:
  truths:
    - "Developer can @mention the bot in a bug thread and see a confirmation reaction + reply with note count"
    - "Empty @mentions show a help message instead of saving"
    - "Editing a Discord message updates the stored note"
    - "Deleting a Discord message removes the stored note"
    - "Only users with the Developer role can add context notes"
    - "Developer can use /view-notes to see all notes for a bug"
    - "Notes counter appears in bug embed after notes are added"
  artifacts:
    - path: "src/models/developer_notes.py"
      provides: "DeveloperNotesRepository with full CRUD"
      exports: ["DeveloperNotesRepository"]
    - path: "src/models/database.py"
      provides: "developer_notes table schema and migration"
      contains: "developer_notes"
    - path: "src/models/bug.py"
      provides: "get_bug_by_thread_id method"
      contains: "get_bug_by_thread_id"
    - path: "src/cogs/developer_notes.py"
      provides: "DeveloperNotesCog with on_message, raw edit/delete, /view-notes"
      exports: ["DeveloperNotesCog"]
    - path: "src/bot.py"
      provides: "message_content intent, notes_repo init, cog loading"
      contains: "message_content"
  key_links:
    - from: "src/cogs/developer_notes.py"
      to: "src/models/developer_notes.py"
      via: "self.notes_repo CRUD calls"
      pattern: "notes_repo\\."
    - from: "src/cogs/developer_notes.py"
      to: "src/models/bug.py"
      via: "get_bug_by_thread_id lookup"
      pattern: "get_bug_by_thread_id"
    - from: "src/bot.py"
      to: "src/models/developer_notes.py"
      via: "DeveloperNotesRepository initialization"
      pattern: "DeveloperNotesRepository"
    - from: "src/cogs/developer_notes.py"
      to: "src/utils/embeds.py"
      via: "Embed rebuild with notes counter after note save"
      pattern: "build_summary_embed"

user_setup:
  - service: discord
    why: "Message Content Intent required for reading @mention text"
    dashboard_config:
      - task: "Enable Message Content Intent toggle"
        location: "Discord Developer Portal -> Bot Application -> Bot -> Privileged Gateway Intents -> Message Content Intent"
---

<objective>
Create the developer notes data layer, DeveloperNotesCog, and bot wiring for Phase 6.

Purpose: Developers need to @mention the bot in bug threads to add context notes that get stored in SQLite and are visible via /view-notes and the bug embed counter. This plan builds the full new subsystem.

Output: New `developer_notes` table, `DeveloperNotesRepository`, `DeveloperNotesCog` with on_message/edit/delete listeners and /view-notes command, bot.py wiring with message_content intent.
</objective>

<execution_context>
@C:/Users/silas/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/silas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-developer-context-via-bot-mentions/06-CONTEXT.md
@.planning/phases/06-developer-context-via-bot-mentions/06-RESEARCH.md

Key existing patterns to follow:
@src/models/database.py (migration pattern: migrate_add_analysis_columns, migrate_add_github_columns)
@src/models/bug.py (BugRepository CRUD pattern, _row_to_dict, _utcnow_iso helpers)
@src/cogs/ai_analysis.py (/set-priority slash command pattern for /view-notes reference)
@src/bot.py (setup_hook wiring, intent config, cog loading)
@src/utils/embeds.py (build_summary_embed for notes counter injection)
@src/views/bug_buttons.py (build_bug_view, _derive_bug_flags for passing note_count)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database schema, DeveloperNotesRepository, and BugRepository extension</name>
  <files>
    src/models/database.py
    src/models/developer_notes.py
    src/models/bug.py
  </files>
  <action>
**src/models/database.py:**

1. Add a `DEVELOPER_NOTES_SCHEMA` constant containing the CREATE TABLE statement:
```sql
CREATE TABLE IF NOT EXISTS developer_notes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    bug_id INTEGER NOT NULL REFERENCES bugs(id),
    discord_message_id INTEGER UNIQUE NOT NULL,
    author_id INTEGER NOT NULL,
    author_name TEXT NOT NULL,
    content TEXT NOT NULL,
    attachment_urls TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
CREATE INDEX IF NOT EXISTS idx_developer_notes_bug_id ON developer_notes(bug_id);
CREATE INDEX IF NOT EXISTS idx_developer_notes_message_id ON developer_notes(discord_message_id);
```

2. Add a `migrate_add_developer_notes` async function following the existing migration pattern (check if table exists via `sqlite_master`, if not execute the schema). Also add an index on `bugs.thread_id` for efficient thread-to-bug lookups:
```sql
CREATE INDEX IF NOT EXISTS idx_bugs_thread_id ON bugs(thread_id);
```

3. Call `migrate_add_developer_notes` in `setup_database()` after the existing migration calls.

**src/models/developer_notes.py (NEW FILE):**

Create `DeveloperNotesRepository` class following the `BugRepository` pattern in `src/models/bug.py`:
- Import `aiosqlite` and reuse `_utcnow_iso` from `src.models.bug` (or define locally)
- `__init__(self, db: aiosqlite.Connection)` -- store db, set row_factory
- `create_note(self, bug_id, discord_message_id, author_id, author_name, content, attachment_urls=None) -> dict` -- INSERT + commit + return the created note
- `get_notes_for_bug(self, bug_id) -> list[dict]` -- SELECT all notes for bug ordered by created_at ASC
- `count_notes(self, bug_id) -> int` -- SELECT COUNT
- `get_note_by_message_id(self, message_id) -> dict | None` -- lookup by discord_message_id
- `update_note_by_message_id(self, message_id, new_content) -> bool` -- UPDATE content + updated_at, return whether row was affected
- `delete_note_by_message_id(self, message_id) -> bool` -- DELETE, return whether row was affected

Store attachment_urls as JSON array string (consistent with console_logs pattern). Use `json.dumps` if provided, store None if no attachments.

**src/models/bug.py:**

Add `get_bug_by_thread_id(self, thread_id: int) -> dict | None` method to `BugRepository`:
```python
async def get_bug_by_thread_id(self, thread_id: int) -> dict | None:
    """Return a bug by its Discord thread_id, or None."""
    async with self.db.execute(
        "SELECT * FROM bugs WHERE thread_id = ?", (thread_id,)
    ) as cursor:
        row = await cursor.fetchone()
        return _row_to_dict(row) if row else None
```
  </action>
  <verify>
Run `python -c "from src.models.developer_notes import DeveloperNotesRepository; print('OK')"` and `python -c "from src.models.database import migrate_add_developer_notes; print('OK')"` to confirm imports work. Run `python -c "import ast; ast.parse(open('src/models/bug.py').read()); print('OK')"` to validate syntax.
  </verify>
  <done>
developer_notes table schema exists in database.py with migration function. DeveloperNotesRepository has full CRUD (create, get_notes_for_bug, count_notes, get_note_by_message_id, update_note_by_message_id, delete_note_by_message_id). BugRepository has get_bug_by_thread_id. Migration creates idx_bugs_thread_id index.
  </done>
</task>

<task type="auto">
  <name>Task 2: DeveloperNotesCog, bot.py wiring, and summary embed notes counter</name>
  <files>
    src/cogs/developer_notes.py
    src/bot.py
    src/utils/embeds.py
    src/views/bug_buttons.py
  </files>
  <action>
**src/cogs/developer_notes.py (NEW FILE):**

Create `DeveloperNotesCog(commands.Cog)` following the ai_analysis.py cog pattern:

1. `__init__(self, bot)` -- store bot reference, create `self.notes_repo = bot.notes_repo`

2. `on_message` listener (`@commands.Cog.listener()`):
   - Skip if `message.author.bot`
   - Skip if `self.bot.user not in message.mentions`
   - Skip if NOT `isinstance(message.channel, discord.Thread)`
   - Lookup bug: `bug = await self.bot.bug_repo.get_bug_by_thread_id(message.channel.id)` -- skip if None
   - Role check: get `self.bot.config.DEVELOPER_ROLE_NAME`, find role with `discord.utils.get(message.guild.roles, name=...)`. If role not found or not in `message.author.roles`, silently return.
   - Strip mention: remove `<@BOT_ID>` and `<@!BOT_ID>` from `message.content` using string replace, then `.strip()`
   - Handle attachments: if `message.attachments`, collect URLs as JSON array string; else None
   - If stripped content is empty and no attachments: reply with help message "Mention me with a message to add developer context for this bug. Example: `@BugBot I think this is caused by the auth token expiring`" and return
   - Save note via `self.notes_repo.create_note(bug["id"], message.id, message.author.id, str(message.author), content, attachment_urls)`
   - React with pencil emoji: `await message.add_reaction("\U0001f4dd")`
   - Count notes: `note_count = await self.notes_repo.count_notes(bug["id"])`
   - Reply: `await message.reply(f"\U0001f4dd Context saved ({note_count} note{'s' if note_count != 1 else ''} for this bug)")`
   - Update summary embed with notes counter: fetch the channel message using `bug["channel_id"]` and `bug["message_id"]`, rebuild embed with `build_summary_embed(bug, note_count=note_count)`, rebuild view with `build_bug_view` using `_derive_bug_flags`, edit the message. Wrap in try/except (non-fatal, log warning on failure).

3. `on_raw_message_delete` listener (`@commands.Cog.listener()`):
   - `payload: discord.RawMessageDeleteEvent`
   - `deleted = await self.notes_repo.delete_note_by_message_id(payload.message_id)`
   - If deleted, log it. Optionally update the embed counter (non-fatal).

4. `on_raw_message_edit` listener (`@commands.Cog.listener()`):
   - `payload: discord.RawMessageUpdateEvent`
   - Check `if "content" not in payload.data: return` (embed-only edits)
   - Strip bot mention from new content (same stripping logic)
   - `updated = await self.notes_repo.update_note_by_message_id(payload.message_id, new_content)`
   - If updated, log it.

5. `/view-notes` slash command following `/set-priority` pattern:
   - `@app_commands.command(name="view-notes", description="View developer context notes for a bug")`
   - `@app_commands.describe(bug_id="The bug hash ID (e.g., a3f2b1c0)")`
   - Defer ephemeral
   - Fetch bug by hash_id via `bot.bug_repo.get_bug(bug_id)`
   - If no bug, send error
   - Fetch notes via `self.notes_repo.get_notes_for_bug(bug["id"])`
   - If no notes, send "No developer notes for this bug."
   - Build an embed listing each note with author and timestamp
   - Send as ephemeral followup

6. `async def setup(bot)` at module level for cog loading.

**src/bot.py:**

1. Enable message_content intent:
   - Change `intents = discord.Intents.default()` block to add `intents.message_content = True`
   - Update the comment from "message_content intent NOT needed" to "message_content intent needed for Phase 6 @mention context notes"

2. Add `from src.models.developer_notes import DeveloperNotesRepository` import

3. Add `self.notes_repo: DeveloperNotesRepository | None = None` attribute in `__init__`

4. In `setup_hook`, after bug_repo initialization, add:
   ```python
   self.notes_repo = DeveloperNotesRepository(self.db)
   logger.info("Developer notes repository initialized")
   ```

5. Add `"src.cogs.developer_notes"` to the `cog_extensions` list.

**src/utils/embeds.py:**

Modify `build_summary_embed` to accept an optional `note_count: int | None = None` keyword argument. After the Pull Request field section (after the `github_pr_url` block, before `embed.set_footer`), add:
```python
# Developer notes counter -- shown when notes exist (Phase 6)
if note_count is not None and note_count > 0:
    embed.add_field(
        name="Developer Notes",
        value=f"\U0001f4dd {note_count}",
        inline=True,
    )
```

**src/views/bug_buttons.py:**

In `_derive_bug_flags`, the function currently returns a dict. It does NOT need to change for the note_count -- the note_count is passed separately to `build_summary_embed` by the callers that have it. No changes to `_derive_bug_flags` or `build_bug_view` needed.

However, import `build_summary_embed` is already imported. The cog will handle embed updates directly. No changes to bug_buttons.py are needed in this task.
  </action>
  <verify>
Run `python -c "from src.cogs.developer_notes import setup; print('OK')"` to validate cog imports. Run `python -c "from src.bot import BugBot; print('OK')"` to validate bot imports. Run `python -c "from src.utils.embeds import build_summary_embed; print('OK')"` to validate embeds. Check that bot.py has `intents.message_content = True` with `grep "message_content" src/bot.py`.
  </verify>
  <done>
DeveloperNotesCog handles @mentions in bug threads (save note, react, reply with count, update embed), edit/delete sync via raw events, and /view-notes slash command. bot.py enables message_content intent, initializes DeveloperNotesRepository, and loads the new cog. Summary embed shows notes counter when notes exist.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.models.developer_notes import DeveloperNotesRepository; print('OK')"` -- repository importable
2. `python -c "from src.cogs.developer_notes import setup; print('OK')"` -- cog importable
3. `python -c "from src.bot import BugBot; print('OK')"` -- bot importable with new wiring
4. `grep -c "message_content" src/bot.py` returns 1+ -- intent is enabled
5. `grep -c "developer_notes" src/models/database.py` returns 1+ -- migration exists
6. `grep -c "get_bug_by_thread_id" src/models/bug.py` returns 1+ -- method exists
7. `grep -c "note_count" src/utils/embeds.py` returns 1+ -- counter parameter exists
</verification>

<success_criteria>
- DeveloperNotesRepository has all 6 CRUD methods and imports cleanly
- DeveloperNotesCog has on_message, on_raw_message_edit, on_raw_message_delete listeners and /view-notes command
- bot.py enables message_content intent, initializes notes_repo, loads developer_notes cog
- database.py has developer_notes migration called from setup_database
- bug.py has get_bug_by_thread_id method
- build_summary_embed accepts note_count parameter and displays counter
- All Python files parse without syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-developer-context-via-bot-mentions/06-01-SUMMARY.md`
</output>
