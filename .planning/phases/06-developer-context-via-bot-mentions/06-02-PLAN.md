---
phase: 06-developer-context-via-bot-mentions
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/services/code_fix_service.py
  - src/services/copilot_fix_service.py
  - src/utils/github_templates.py
  - src/views/bug_buttons.py
autonomous: false
requirements: [DEV-06, DEV-07, DEV-08]

must_haves:
  truths:
    - "Developer notes are included in the Anthropic code fix prompt when they exist"
    - "Developer notes are included in the Copilot issue body and custom instructions when they exist"
    - "PR body contains a Developer Notes section with author and timestamp for each note"
    - "Clicking Draft Fix when no developer notes exist shows a confirmation hint before proceeding"
    - "Developer notes flow end-to-end from Discord to PR body"
  artifacts:
    - path: "src/services/code_fix_service.py"
      provides: "Developer notes section in code fix prompt"
      contains: "developer_notes"
    - path: "src/services/copilot_fix_service.py"
      provides: "Developer notes in issue body and custom instructions"
      contains: "developer_notes"
    - path: "src/utils/github_templates.py"
      provides: "Developer Notes section in PR body"
      contains: "Developer Notes"
    - path: "src/views/bug_buttons.py"
      provides: "Draft Fix no-context warning and notes passthrough"
      contains: "developer_notes"
  key_links:
    - from: "src/views/bug_buttons.py"
      to: "src/models/developer_notes.py"
      via: "Fetch notes in _handle_draft_fix before calling fix service"
      pattern: "notes_repo\\.get_notes_for_bug"
    - from: "src/views/bug_buttons.py"
      to: "src/services/code_fix_service.py"
      via: "Pass developer_notes to generate_fix"
      pattern: "developer_notes="
    - from: "src/services/code_fix_service.py"
      to: "prompt builder"
      via: "_build_code_fix_prompt includes developer notes section"
      pattern: "Developer Notes"
    - from: "src/utils/github_templates.py"
      to: "PR body"
      via: "build_code_fix_pr_body includes developer notes section"
      pattern: "Developer Notes"
---

<objective>
Integrate developer notes into the code fix pipeline and add Draft Fix no-context warning.

Purpose: Developer notes stored in Plan 01 must flow into the AI code fix prompt (both Anthropic and Copilot modes), appear in PR bodies for traceability, and the Draft Fix button must warn when no developer context exists. This closes the loop from Discord mention to PR.

Output: Modified fix services, PR templates, and Draft Fix handler with developer notes integration.
</objective>

<execution_context>
@C:/Users/silas/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/silas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-developer-context-via-bot-mentions/06-CONTEXT.md
@.planning/phases/06-developer-context-via-bot-mentions/06-RESEARCH.md
@.planning/phases/06-developer-context-via-bot-mentions/06-01-SUMMARY.md

Key files to modify:
@src/services/code_fix_service.py (line 315-381: _build_code_fix_prompt, line ~282: generate_fix signature)
@src/services/copilot_fix_service.py (line 247-262: _build_issue_body, line 264-277: _build_custom_instructions, line 283: generate_fix signature)
@src/utils/github_templates.py (line 380-478: build_code_fix_pr_body)
@src/views/bug_buttons.py (line 445-806: _handle_draft_fix)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inject developer notes into fix services and PR body template</name>
  <files>
    src/services/code_fix_service.py
    src/services/copilot_fix_service.py
    src/utils/github_templates.py
  </files>
  <action>
**src/services/code_fix_service.py:**

1. Modify `_build_code_fix_prompt` to accept an optional `developer_notes: list[dict] | None = None` parameter. After the "AI Analysis" section in the prompt string (after the `{files_section}` line, before the "Instructions:" block), insert a developer notes section:
```python
# Developer notes section
notes_section = ""
if developer_notes:
    notes_lines = []
    for note in developer_notes:
        author = note.get("author_name", "Unknown")
        content = note.get("content", "")
        timestamp = note.get("created_at", "")
        notes_lines.append(f"  [{author} at {timestamp}]: {content}")
    notes_section = (
        "\n"
        "Developer Notes (from team members -- consider these alongside the AI analysis):\n"
        + "\n".join(notes_lines)
    )
```
Insert `{notes_section}` in the prompt string after `{files_section}`.

2. Modify `generate_fix` to accept an optional `developer_notes: list[dict] | None = None` parameter. Pass it through to `_build_code_fix_prompt` and `_run_generation_round` calls. The `_run_generation_round` method passes it to `_build_code_fix_prompt` for round 1.

**src/services/copilot_fix_service.py:**

1. Modify `_build_issue_body` to accept an optional `developer_notes: list[dict] | None = None` parameter. Before the footer line (`---\n*Created by BugBot...`), add:
```python
if developer_notes:
    body_parts.append("\n### Developer Notes\n")
    for note in developer_notes:
        author = note.get("author_name", "Unknown")
        content = note.get("content", "")
        timestamp = note.get("created_at", "")
        body_parts.append(f"- **{author}** ({timestamp}): {content}\n")
```
Note: The current method returns a single f-string. Refactor to build parts list and join, OR construct the developer notes section string and insert before the footer. Keep backward compatible (no notes = same output as before).

2. Modify `_build_custom_instructions` to accept an optional `developer_notes: list[dict] | None = None` parameter. If notes exist, append a summary:
```python
if developer_notes:
    notes_summary = "; ".join(
        f"{n['author_name']}: {n['content']}" for n in developer_notes
    )
    parts.append(f"Developer notes: {notes_summary}")
```

3. Modify `generate_fix` to accept an optional `developer_notes: list[dict] | None = None` parameter. Pass it to `_build_issue_body` and `_build_custom_instructions` calls.

**src/utils/github_templates.py:**

1. Modify `build_code_fix_pr_body` to accept an optional `developer_notes: list[dict] | None = None` parameter. After the "AI Analysis" section and before the "Changes Made" section, add:
```python
# Developer Notes section (Phase 6 traceability)
if developer_notes:
    sections.extend(["", "### Developer Notes"])
    for note in developer_notes:
        author = note.get("author_name", "Unknown")
        content = note.get("content", "")
        timestamp = note.get("created_at", "")
        sections.append(f"- **{author}** ({timestamp}): {content}")
```
This ensures developer notes appear in the PR body with author and timestamp per locked decision.
  </action>
  <verify>
Run `python -c "from src.services.code_fix_service import CodeFixService; print('OK')"` and `python -c "from src.services.copilot_fix_service import CopilotFixService; print('OK')"` and `python -c "from src.utils.github_templates import build_code_fix_pr_body; print('OK')"` to confirm all imports still work. Verify the new parameters exist: `python -c "import inspect; from src.services.code_fix_service import CodeFixService; sig = inspect.signature(CodeFixService.generate_fix); assert 'developer_notes' in sig.parameters; print('OK')"`.
  </verify>
  <done>
CodeFixService._build_code_fix_prompt includes developer notes section when notes exist. CopilotFixService._build_issue_body and _build_custom_instructions include developer notes. build_code_fix_pr_body includes Developer Notes section in PR body. All generate_fix signatures accept developer_notes parameter. No notes = identical behavior to before.
  </done>
</task>

<task type="auto">
  <name>Task 2: Draft Fix handler fetches notes, shows no-context warning, and passes notes to fix service</name>
  <files>
    src/views/bug_buttons.py
  </files>
  <action>
Modify `_handle_draft_fix` in `src/views/bug_buttons.py`:

1. **Fetch developer notes** -- after fetching the bug (step 2, around line 453) and before the guard checks, add:
```python
# Fetch developer notes for this bug
developer_notes = []
if bot.notes_repo is not None:
    try:
        developer_notes = await bot.notes_repo.get_notes_for_bug(bug["id"])
    except Exception as exc:
        logger.warning("Failed to fetch developer notes for bug %s: %s", self.bug_id, exc)
```

2. **No-context warning** -- after all guard checks pass (after the code_fix_service None check, before the guild config fetch), if `not developer_notes`, show an ephemeral confirmation hint per locked decision. Use the approach recommended in RESEARCH.md: an ephemeral followup message. Since we've already deferred, send an ephemeral followup:
```python
# Draft Fix warning: no developer context (per locked decision)
if not developer_notes:
    await interaction.followup.send(
        "\u26a0\ufe0f **No developer context provided.** "
        "You can @mention me in the bug thread to add context notes before drafting a fix. "
        "Click **Draft Fix** again to proceed without context.",
        ephemeral=True,
    )
    return
```
IMPORTANT: This blocks the first click. The user clicks Draft Fix again to confirm. This matches the RESEARCH.md recommendation: "Use an ephemeral followup message... Click Draft Fix again to proceed." The guard at step 2 already blocks re-triggers if a branch exists, so a second click only proceeds when no branch exists yet.

Wait -- the user decision says "show a confirmation hint" not "block." But the research recommendation says "Click Draft Fix again to proceed" which IS blocking the first click. The user decision is: "if no developer context exists when Draft Fix is clicked, show a confirmation hint ('No developer context provided. Continue anyway?')". Let me implement as a non-blocking warning that still proceeds. Actually, re-reading: the research says "Use an ephemeral followup message with text like 'No developer context provided. Click Draft Fix again to proceed.' This avoids complex modal/button state."

This means: first click with no notes -> show warning + return (don't proceed). Second click -> same check, but we need a way to bypass it. The simplest approach: store a transient flag. BUT that adds complexity. Simpler: always proceed but warn. Let me re-read the user decision: "show a confirmation hint ('No developer context provided. Continue anyway?')". The "Continue anyway?" phrasing suggests it's informational, not blocking.

REVISED APPROACH: Show the warning as an ephemeral followup but DON'T return -- let the code continue. This is informational, not blocking:
```python
# Draft Fix warning: no developer context (per locked decision)
if not developer_notes:
    try:
        await interaction.followup.send(
            "\u26a0\ufe0f No developer context provided. Proceeding without developer notes. "
            "Tip: @mention me in the bug thread to add context before drafting a fix.",
            ephemeral=True,
        )
    except discord.HTTPException:
        pass  # Non-fatal
```
This sends the warning and proceeds. The user sees the informational hint.

3. **Pass developer_notes to generate_fix** -- in the `fix_result = await bot.code_fix_service.generate_fix(...)` call (around line 586), add `developer_notes=developer_notes` keyword argument.

4. **Pass developer_notes to build_code_fix_pr_body** -- in the Anthropic mode PR body builder call (around line 632), add `developer_notes=developer_notes` keyword argument.
  </action>
  <verify>
Run `python -c "import ast; ast.parse(open('src/views/bug_buttons.py').read()); print('OK')"` to validate syntax. Run `grep -c "developer_notes" src/views/bug_buttons.py` to confirm notes integration (should be 4+). Run `grep "No developer context" src/views/bug_buttons.py` to confirm warning exists.
  </verify>
  <done>
_handle_draft_fix fetches developer notes from notes_repo, shows informational warning when no notes exist, passes developer_notes to both generate_fix and build_code_fix_pr_body. Notes flow end-to-end from storage through fix service into PR body. Warning is non-blocking per user decision phrasing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify developer context flow end-to-end</name>
  <files>N/A -- verification only</files>
  <action>
Human verification checkpoint. What was built:

Complete developer context via @bot mentions feature:
1. @mention the bot in a bug thread to add context notes (stored in SQLite)
2. Notes appear in /view-notes, bug embed counter, and PR body
3. Notes are injected into AI code fix prompts (both Anthropic and Copilot modes)
4. Draft Fix warns when no developer context exists
5. Message edits update notes, message deletes remove notes
6. Only Developer role can add notes

**IMPORTANT:** Message Content Intent must be enabled in the Discord Developer Portal for the bot application (Bot -> Privileged Gateway Intents -> Message Content Intent toggle).

Steps to verify:
1. **Enable Message Content Intent** in Discord Developer Portal (Bot -> Privileged Gateway Intents -> Message Content Intent)
2. Start the bot: `docker compose up` or `python -m src.bot`
3. In a bug thread, @mention the bot with a message like "@BugBot I think this is a race condition in the auth module"
4. Verify: bot reacts with pencil emoji and replies "Context saved (1 note for this bug)"
5. Add another note: "@BugBot The issue seems related to token refresh timing"
6. Verify: reply says "(2 notes for this bug)"
7. Check the bug embed in the channel: should show "Developer Notes" field with pencil emoji and count
8. Run `/view-notes` with the bug's hash ID: should show both notes with authors and timestamps
9. Edit your first message: verify the note is updated (check via /view-notes)
10. Delete your second message: verify note count drops to 1
11. Try an empty mention "@BugBot" with no text: should get help message
12. Click Draft Fix on the bug: should see warning about no developer context (if notes are gone) or proceed with notes

Resume signal: Type "approved" or describe issues to fix.
  </action>
  <verify>Human confirms all 12 verification steps pass.</verify>
  <done>Developer context via @bot mentions feature verified end-to-end by human tester.</done>
</task>

</tasks>

<verification>
1. `grep "developer_notes" src/services/code_fix_service.py` -- present in prompt builder and generate_fix
2. `grep "developer_notes" src/services/copilot_fix_service.py` -- present in issue body, instructions, and generate_fix
3. `grep "Developer Notes" src/utils/github_templates.py` -- section in PR body template
4. `grep "developer_notes" src/views/bug_buttons.py` -- fetched and passed through Draft Fix handler
5. `grep "No developer context" src/views/bug_buttons.py` -- warning message exists
6. All Python files parse without syntax errors
</verification>

<success_criteria>
- CodeFixService._build_code_fix_prompt includes developer notes in the prompt when provided
- CopilotFixService._build_issue_body includes Developer Notes section when notes exist
- CopilotFixService._build_custom_instructions includes notes summary when notes exist
- build_code_fix_pr_body includes Developer Notes section in PR body when notes exist
- _handle_draft_fix fetches notes, warns on empty, passes notes to fix service and PR builder
- Human has verified the end-to-end flow from @mention to stored note to prompt to PR body
</success_criteria>

<output>
After completion, create `.planning/phases/06-developer-context-via-bot-mentions/06-02-SUMMARY.md`
</output>
